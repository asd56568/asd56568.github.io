<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯šä¿¡è€ƒè¯•æ‰¿è¯ºä¹¦ç­¾ç½²</title>
    <!-- å¼•å…¥ LeanCloud JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.1/dist/av-min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; color: #333; background-color: #f9fafb; margin: 0; padding: 20px; }
        
        /* æ­¥éª¤æŒ‡ç¤ºå™¨æ ·å¼ */
        .step-indicator { text-align: center; margin: 30px 0; }
        .step { display: inline-block; margin: 0 20px; text-align: center; opacity: 0.5; }
        .step.active { opacity: 1; font-weight: bold; }
        .step.active .step-circle { background-color: #16a34a; color: white; }
        .step.completed .step-circle { background-color: #666 !important; color: white !important; }
        .step-circle { width: 30px; height: 30px; border-radius: 50%; background-color: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; }

        /* å†…å®¹åŒºåŸŸæ ·å¼ */
        .content-section { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
        .text-content { line-height: 1.8; font-size: 16px; }
        .text-content h2 { text-align: center; margin-bottom: 30px; color: #000; font-size: 24px; font-weight: bold; }
        .text-content p { margin-bottom: 15px; text-align: justify; }
        .indent-text { text-indent: 2em; }
        
        /* æŒ‰é’®ä¸è¡¨å•æ ·å¼ */
        .read-complete-btn { display: block; margin: 30px auto 0; padding: 12px 30px; background: #16a34a; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background 0.3s; }
        .read-complete-btn:hover { background: #15803d; }
        
        .signature-section, .submit-section { max-width: 600px; margin: 0 auto; padding-top: 20px; }
        .signature-title { text-align: center; margin-bottom: 20px; }
        
        .student-info { margin-bottom: 20px; }
        .info-item { margin: 15px 0; display: flex; align-items: center; }
        .info-item label { width: 60px; font-weight: bold; }
        .info-item input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .info-item input:focus { outline: none; border-color: #16a34a; box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.1); }

        .signature-area { border: 2px dashed #ddd; border-radius: 4px; margin: 20px 0; background: #fafafa; }
        #signatureCanvas { width: 100%; display: block; }
        
        .signature-controls { text-align: center; margin-top: 20px; }
        .btn { padding: 10px 25px; border: none; border-radius: 4px; cursor: pointer; margin: 0 10px; font-size: 14px; }
        .clear-btn { background: #f3f4f6; color: #333; border: 1px solid #ddd; }
        .final-submit-btn { background: #16a34a; color: white; padding: 12px 40px; font-size: 16px; margin-top: 20px; width: 100%; }
        
        .confirmation-message { text-align: center; margin-bottom: 30px; }
        .confirmation-message h3 { color: #16a34a; font-size: 22px; margin-bottom: 15px; }
        
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #16a34a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 600px) {
            .content-section { padding: 20px; }
            .info-item { flex-direction: column; align-items: flex-start; }
            .info-item label { margin-bottom: 5px; }
            .info-item input { width: 100%; box-sizing: border-box; }
        }
    </style>
</head>
<body>

<!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
<div class="step-indicator">
    <div class="step active" id="step1">
        <div class="step-circle">1</div>
        <span>é˜…è¯»æ‰¿è¯ºä¹¦</span>
    </div>
    <div class="step" id="step2">
        <div class="step-circle">2</div>
        <span>ç”µå­ç­¾å­—</span>
    </div>
    <div class="step" id="step3">
        <div class="step-circle">3</div>
        <span>ç¡®è®¤æäº¤</span>
    </div>
</div>

<div class="content-section">
    <!-- æ–‡æ¡£é˜…è¯»åŒºåŸŸ (å·²ä¿®æ”¹ä¸ºæ–°å†…å®¹) -->
    <div class="text-content" id="textContent">
        <h2>è¯šä¿¡è€ƒè¯•æ‰¿è¯ºä¹¦</h2>
        
        <p class="indent-text">åŒå­¦ä»¬ï¼Œä¸ºäº†åŠ å¼ºè€ƒé£è€ƒçºªæ•™è‚²ï¼Œæé«˜åŒå­¦ä»¬çš„è¯šä¿¡æ„è¯†å’Œè¯šä¿¡ç´ è´¨ï¼ŒåŠªåŠ›åŸ¹å…»å’Œé€ å°±è¯šä¿¡äººæ‰ï¼Œæœ¬ç€â€œæ ‘é“å¾·ä¹‹æ–°é£ï¼Œç«‹è¯šä¿¡ä¹‹æ ¹ æœ¬â€çš„å®—æ—¨ï¼Œåœ¨è€ƒè¯•ä¸­åšå‡ºå¦‚ä¸‹æ‰¿è¯ºï¼š</p>
        
        <p>ä¸€ã€å­¦ç”Ÿåº”å½“è‡ªè§‰éµå®ˆè€ƒåœºå®ˆåˆ™ï¼Œè¯šå®å®ˆä¿¡ï¼Œå¢å¼ºéµçºªå®ˆæ³•è‡ªè§‰æ€§ï¼Œä¸¥ç¦å‡ºç°å„ç±»è¿è§„è¡Œä¸ºã€‚</p>
        <p>äºŒã€æºå¸¦è§„å®šçš„ç‰©å“è¿›å…¥è€ƒåœºå¹¶æ”¾åœ¨æŒ‡å®šä½ç½®ï¼Œåœ¨è§„å®šçš„åº§ä½å‚åŠ è€ƒè¯•ã€‚</p>
        <p>ä¸‰ã€è€ƒç”Ÿä¸å¾—åœ¨è¯¾æ¡Œå†…ã€è¯¾æ¡Œä¸Šå†™ä¸è€ƒè¯•ç§‘ç›®æœ‰å…³çš„å†…å®¹ã€‚åœ¨è€ƒè¯•å¼€å§‹å‰ï¼Œå¦‚å‘ç°æœ‰å…³å†…å®¹ï¼Œè¦ä¸»åŠ¨è¯·ç›‘è€ƒæ•™å¸ˆè°ƒæ¢åº§ä½æˆ–è€…æ“¦é™¤ã€‚</p>
        <p>å››ã€è€ƒè¯•æ—¶ï¼Œé™¤å¿…è¦æ–‡å…·å’Œç›‘è€ƒæ•™å¸ˆåŒæ„å¸¦è¿›è€ƒåœºçš„ç‰©å“å¤–ï¼Œå…¶å®ƒæœªç»ç›‘è€ƒæ•™å¸ˆå…è®¸å¸¦å…¥è€ƒåœºçš„ä¹¦ç±ã€è®²ä¹‰ã€ç¬”è®°ã€ç”µå­ã€æ‰‹æœºåŠé€šè®¯è®¾å¤‡ç­‰ç‰©å“ã€‚</p>
        <p>äº”ã€è€ƒç”Ÿåœ¨è€ƒè¯•è¿‡ç¨‹ä¸­ä¸å…è®¸æ—çª¥ã€ä¸å¾—ä¼ é€’ä»»ä½•ç‰©å“ã€äº¤å¤´æ¥è€³ã€äº’æ‰“æš—å·æˆ–è€…æ‰‹åŠ¿ï¼›å¦‚è¯•é¢˜å­—è¿¹ä¸æ¸…æ—¶ï¼Œå¯ä¸¾æ‰‹ç¤ºæ„ï¼Œè¯¢é—®æ•™å¸ˆã€‚</p>
        <p>å…­ã€è€ƒç”Ÿä¸¥ç¦è‡ªå¸¦çº¸å¼ ã€‚è€ƒç”Ÿçš„è¯•é¢˜ã€ç­”é¢˜çº¸ã€ç­”é¢˜å¡ã€è‰ç¨¿çº¸ç­‰ç”±ç›‘è€ƒæ•™å¸ˆç»Ÿä¸€å‘æ”¾ï¼Œè€ƒè¯•ç»“æŸåç»Ÿä¸€æ”¶å›ã€‚æ— è®ºä½•ç§æƒ…å†µï¼Œä¸¥ç¦å°†ä¸Šè¿°ç‰©å“å¸¦å‡ºè€ƒåœºã€‚</p>
        <p>ä¸ƒã€ä¸æŠ„è¢­æˆ–è€…ååŠ©ä»–äººæŠ„è¢­è¯•é¢˜ç­”æ¡ˆæˆ–ä¸è€ƒè¯•å†…å®¹ç›¸å…³çš„èµ„æ–™ã€‚</p>
        <p>å…«ã€ä¸ç”±ä»–äººå†’åä»£æ›¿å‚åŠ è€ƒè¯•ã€‚</p>
        <p>ä¹ã€çæƒœå®è´µæ—¶é—´ï¼Œè®¤çœŸå¤ä¹ è¿è€ƒã€‚ä¸å…¶è€ƒè¯•æ—¶æ‰‹å¿™è„šä¹±ï¼Œæ‡Šæ‚”ä¸å·²ï¼Œä¸å¦‚ä¿æŒå¹³å’Œè€Œç§¯æçš„å¿ƒæ€ï¼Œè®¤çœŸå¤ä¹ ï¼Œç§¯æå¤‡è€ƒï¼Œåšå¥½å……åˆ†çš„å‡†å¤‡ã€‚</p>
        <p>åã€æé«˜æ€æƒ³è®¤è¯†ï¼Œç«¯æ­£å­¦ä¹ ä¸è€ƒè¯•çš„æ€åº¦ã€‚è€ƒè¯•ä½œå¼Šä¸ä»…æ˜¯å¯¹ä¸ªäººèƒ½åŠ›çš„å¦å®šå’Œè”‘è§†ï¼Œæ›´æ˜¯å¯¹å­¦æœ¯é£æ°”çš„äºµæ¸ï¼Œä½œå¼Šè€…ä¸¢æ‰çš„ä¸ä»…ä»…æ˜¯å­¦ä½ï¼Œæ›´æ˜¯å®è´µçš„è¯šä¿¡å“è´¨ã€‚</p>
        
        <p class="indent-text" style="margin-top: 20px;">æœ¬äººç­¾æ­¤è¯šä¿¡è€ƒè¯•æ‰¿è¯ºä¹¦ï¼Œå¹¶ä¸¥æ ¼éµå®ˆè€ƒè¯•çš„ç›¸å…³è§„å®šã€‚å¦‚æœ‰è¿åï¼Œè‡ªè§‰æŒ‰ç…§ç›¸å…³è§„å®šæ¥å—ç›¸åº”çš„æƒ©ç½šã€‚</p>
        <p class="indent-text">è‰¯å¥½çš„å­¦é£ã€æ–‡æ˜çš„æ ¡é£éœ€è¦æˆ‘ä»¬å…±åŒç»´æŠ¤ï¼Œè®©æˆ‘ä»¬ä»¥è¯šä¿¡çš„æ€åº¦å¯¹å¾…æ¯ä¸€åœºè€ƒè¯•ï¼Œè€ƒå‡ºçœŸå®çš„æ°´å¹³ï¼Œåšå®ˆçœŸå®çš„è‡ªæˆ‘ã€‚</p>
        
        <div style="text-align: right; margin-top: 40px; margin-bottom: 20px; font-weight: bold; line-height: 1.6;">
            æ§åˆ¶ä¸è®¡ç®—æœºå·¥ç¨‹å­¦é™¢<br>
            2025.11.26
        </div>
        
        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            <p>å­¦ç”Ÿé˜…è¯»åç­¾åï¼š________________ï¼ˆè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›è¡Œç”µå­ç­¾åï¼‰</p>
        </div>
    </div>

    <button class="read-complete-btn" id="readCompleteBtn" onclick="showSignature()">
        æˆ‘å·²é˜…è¯»å®Œæ¯•ï¼Œè¿›å…¥ç­¾å­—
    </button>

    <!-- ç­¾å­—åŒºåŸŸ -->
    <div class="signature-section" id="signatureSection" style="display: none;">
        <h2 class="signature-title">è¯·å¡«å†™ä¸ªäººä¿¡æ¯å¹¶ç­¾ç½²æ‚¨çš„å§“å</h2>
        
        <div class="student-info">
            <div class="info-item">
                <label for="studentName">å§“åï¼š</label>
                <input type="text" id="studentName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required>
            </div>
            <div class="info-item">
                <label for="studentId">å­¦å·ï¼š</label>
                <input type="text" id="studentId" placeholder="è¯·è¾“å…¥æ‚¨çš„å­¦å·" required>
            </div>
            <div class="info-item">
                <label for="studentClass">ç­çº§ï¼š</label>
                <input type="text" id="studentClass" placeholder="è¯·è¾“å…¥æ‚¨çš„ç­çº§ï¼ˆå¦‚ï¼šè®¡ç§‘2301ï¼‰" required>
            </div>
        </div>
        
        <div class="signature-area">
            <canvas id="signatureCanvas" width="600" height="200"></canvas>
        </div>
        <div class="signature-controls">
            <button class="btn clear-btn" onclick="clearSignature()">æ¸…é™¤ç­¾å­—</button>
            <button class="btn" style="background: #16a34a; color: white;" onclick="completeSignature()">å®Œæˆç­¾å­—</button>
        </div>
    </div>

    <!-- ç¡®è®¤æäº¤åŒºåŸŸ -->
    <div class="submit-section" id="submitSection" style="display: none;">
        <div class="confirmation-message">
            <h3>âœ… ç­¾å­—å®Œæˆ</h3>
            <p>æ‚¨å·²æˆåŠŸé˜…è¯»ã€Šè¯šä¿¡è€ƒè¯•æ‰¿è¯ºä¹¦ã€‹å¹¶å®Œæˆç”µå­ç­¾å­—ï¼Œè¯·ç¡®è®¤æäº¤ä»¥å®Œæˆæ‰¿è¯ºæµç¨‹ã€‚</p>
        </div>
        <button class="btn final-submit-btn" onclick="finalSubmit()">ç¡®è®¤æäº¤æ‰¿è¯º</button>
    </div>
</div>

<!-- ä¸Šä¼ ä¸­åŠ è½½æç¤º -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div style="font-size: 16px; color: #555;">æ­£åœ¨æäº¤æ‰¿è¯ºä¹¦ï¼Œè¯·ç¨å€™...</div>
</div>

<script>
    let canvas, ctx;
    let isDrawing = false;
    let hasSignature = false;

    // åˆå§‹åŒ– LeanCloud
    AV.init({
        appId: "v6tDMHtbS0q1Faaf1cNMELaP-gzGzoHsz",
        appKey: "VGsQLkmnTkqUYmOsMAdgeaKA",
        serverURL: "https://v6tdmhtb.lc-cn-n1-shared.com"
    });

    // åˆå§‹åŒ–ç”»å¸ƒ
    function initCanvas() {
        canvas = document.getElementById('signatureCanvas');
        ctx = canvas.getContext('2d');
        
        const containerWidth = document.querySelector('.signature-area').offsetWidth;
        canvas.width = Math.min(600, containerWidth - 4); // å‡å»è¾¹æ¡†
        canvas.height = 200;
        
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.fillStyle = '#fff'; // ç¡®ä¿èƒŒæ™¯æ˜¯ç™½è‰²ï¼Œé˜²æ­¢å¯¼å‡ºé€æ˜å›¾ç‰‡
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ç»‘å®šäº‹ä»¶
        const events = [
            ['mousedown', startDrawing],
            ['mousemove', draw],
            ['mouseup', stopDrawing],
            ['mouseout', stopDrawing],
            ['touchstart', handleTouch],
            ['touchmove', handleTouch],
            ['touchend', stopDrawing]
        ];
        
        events.forEach(([type, handler]) => canvas.addEventListener(type, handler, { passive: false }));
    }

    function startDrawing(e) {
        isDrawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        hasSignature = true;
    }

    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }

    function stopDrawing() {
        isDrawing = false;
    }

    function handleTouch(e) {
        if (e.type === 'touchstart') startDrawing(e);
        else if (e.type === 'touchmove') draw(e);
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    // æµç¨‹æ§åˆ¶å‡½æ•°
    function showSignature() {
        document.getElementById('textContent').style.display = 'none';
        document.getElementById('readCompleteBtn').style.display = 'none';
        document.getElementById('signatureSection').style.display = 'block';
        updateSteps(2);
        setTimeout(initCanvas, 100);
    }

    function clearSignature() {
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        hasSignature = false;
    }

    function completeSignature() {
        const name = document.getElementById('studentName').value.trim();
        const id = document.getElementById('studentId').value.trim();
        const cls = document.getElementById('studentClass').value.trim();
        
        if (!name || !id || !cls) return alert('è¯·å®Œæ•´å¡«å†™å§“åã€å­¦å·å’Œç­çº§ï¼');
        if (!hasSignature) return alert('è¯·å…ˆåœ¨æ–¹æ¡†å†…ç­¾åï¼');
        
        document.getElementById('signatureSection').style.display = 'none';
        document.getElementById('submitSection').style.display = 'block';
        updateSteps(3);
    }

    function finalSubmit() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        const name = document.getElementById('studentName').value.trim();
        const id = document.getElementById('studentId').value.trim();
        const cls = document.getElementById('studentClass').value.trim();
        const signatureBase64 = canvas.toDataURL('image/png');
        
        const file = new AV.File(`sign_${id}_${Date.now()}.png`, dataURLToBlob(signatureBase64));
        
        file.save().then(savedFile => {
            const Commitment = AV.Object.extend('HonestyCommitment');
            const record = new Commitment();
            
            record.set('studentName', name);
            record.set('studentId', id);
            record.set('studentClass', cls);
            record.set('signatureUrl', savedFile.url());
            record.set('submitTime', new Date());
            record.set('status', 'å·²ç¡®è®¤');
            record.set('device', /mobile|android|iphone/i.test(navigator.userAgent) ? 'ç§»åŠ¨ç«¯' : 'PCç«¯');
            // æ›´æ–°æ­¤å¤„æ–‡æ¡£åç§°ä»¥åŒ¹é…æ–°å†…å®¹
            record.set('documentName', 'è¯šä¿¡è€ƒè¯•æ‰¿è¯ºä¹¦'); 
            
            return record.save();
        }).then(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            alert(`ğŸ‰ æäº¤æˆåŠŸï¼\n\n${name} åŒå­¦ï¼Œæ‚¨å·²æˆåŠŸç­¾ç½²ã€Šè¯šä¿¡è€ƒè¯•æ‰¿è¯ºä¹¦ã€‹ã€‚\nç¥æ‚¨è€ƒè¯•é¡ºåˆ©ï¼Œå–å¾—ä¼˜å¼‚æˆç»©ï¼`);
            // å¯ä»¥åœ¨æ­¤å¤„æ·»åŠ è·³è½¬æˆ–é‡ç½®é€»è¾‘
        }).catch(error => {
            document.getElementById('loadingOverlay').style.display = 'none';
            console.error(error);
            alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚\né”™è¯¯ä¿¡æ¯ï¼š' + error.message);
        });
    }

    // å·¥å…·å‡½æ•°
    function dataURLToBlob(dataURL) {
        const arr = dataURL.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]);
        let n = bstr.length, u8arr = new Uint8Array(n);
        while(n--) u8arr[n] = bstr.charCodeAt(n);
        return new Blob([u8arr], {type:mime});
    }

    function updateSteps(stepNum) {
        for(let i=1; i<=3; i++) {
            const el = document.getElementById('step'+i);
            el.classList.remove('active', 'completed');
            if(i < stepNum) el.classList.add('completed');
            if(i === stepNum) el.classList.add('active');
        }
    }

    // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç½®ç”»å¸ƒå°ºå¯¸ï¼ˆç®€å•å¤„ç†ï¼‰
    window.addEventListener('resize', () => {
        if(document.getElementById('signatureSection').style.display === 'block') {
            initCanvas();
        }
    });
</script>

</body>
</html>
