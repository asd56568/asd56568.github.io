<!-- 步骤指示器 -->
<div class="step-indicator">
    <div class="step active" id="step1">
        <div class="step-circle">1</div>
        <span>阅读守则</span>
    </div>
    <div class="step" id="step2">
        <div class="step-circle">2</div>
        <span>电子签字</span>
    </div>
    <div class="step" id="step3">
        <div class="step-circle">3</div>
        <span>确认提交</span>
    </div>
</div>

<div class="content-section">
    <!-- 文档阅读区域 -->
    <div class="text-content" id="textContent">
        <h3>华北电力大学控制与计算机工程学院高等数学期中考试诚信守则</h3>
        
        <p>亲爱的同学们：</p>
        
        <p>当秋意渐浓，银杏叶铺就校园的金黄，我们迎来了高等数学期中考试的检验时刻。这场考试不仅是对半学期知识积累的复盘，更是对科学精神与人格品质的双重淬炼。为营造风清气正的考试氛围，守护每一位同学的付出与尊严，学院特发布《高等数学期中考试诚信守则》，愿我们以笔为剑、以诚立身，共同书写无愧于心的答卷。</p>
        
        <h4>一、手机使用规范：工具为学，而非投机之器</h4>
        <p>本次考试允许携带手机，但仅限查看电子试卷（如通过指定平台接收题目），严禁以下行为：</p>
        <p><strong>禁用通讯功能</strong>：关闭微信、QQ、短信等社交软件，退出所有学习类APP（如拍照搜题、在线翻译、公式查询工具）；</p>
        <p><strong>禁止拍摄传递</strong>：不得用手机拍摄试卷、草稿纸或答案，更不可通过拍照、录屏等方式向场外传递信息；</p>
        <p><strong>杜绝辅助计算</strong>：禁止使用计算器类APP、数学解题软件（如Wolfram Alpha）或其他智能工具获取解题步骤；</p>
        <p><strong>专注答题场景</strong>：手机需放置于桌面左上角（监考教师指定位置），全程保持屏幕朝下，非查看题目时不得触碰。</p>
        <p>请牢记：手机是学习的延伸，而非投机的捷径。任何试图利用科技手段突破规则的行为，都是对学术底线的践踏。</p>
        
        <h4>二、诚信为本：以真才实学，赴青春之约</h4>
        <p>高等数学作为控制与计算机学科的“基石”，其严谨性与逻辑性贯穿专业学习的始终。诚信考试，既是对知识的尊重，更是对未来的负责：</p>
        <p><strong>拒绝侥幸心理</strong>：一道题的抄袭、一个公式的照搬，或许能暂时掩盖漏洞，却会让你在未来的专业挑战中失去底气；</p>
        <p><strong>珍视集体荣誉</strong>：一人作弊，损害的是整个学院的学风；人人守诺，方能铸就“学在电院”的金字招牌；</p>
        <p><strong>坚守人格底色</strong>：诚信是比分数更重要的“必修课”。今日考场上的坦荡，终将成为你未来科研攻关、职场竞争中最坚实的底色。</p>
        
        <h4>三、考场纪律：细节见品格，规则护公平</h4>
        <p>除手机使用外，请严格遵守以下考场要求：</p>
        <p>• 凭学生证/校园卡入场，按指定座位就座，不得擅自调换；</p>
        <p>• 开考15分钟后不得入场，开考60分钟内不得交卷离场；</p>
        <p>• 除必要文具（黑色签字笔、尺规、无存储功能的计算器）外，其他物品（如书籍、笔记、电子设备）一律放至指定区域；</p>
        <p>• 遇试卷印刷不清等问题，举手示意监考教师，不得私自交流；</p>
        <p>• 交卷后迅速离开考场，不得在走廊、教室附近逗留讨论。</p>
        
        <h4>四、违规必究：莫让一时糊涂，毁掉一生清誉</h4>
        <p>学院将以“零容忍”态度严肃处理违规行为：</p>
        <p>• 凡发现携带手机作弊、夹带小抄、替考等行为，一律按《华北电力大学学生违纪处分规定》给予记过及以上处分，取消该课程成绩并记入个人档案；</p>
        <p>• 情节严重者（如组织作弊、传播试题），将移交学校相关部门处理，并依法追究责任；</p>
        <p>• 监考教师将通过巡考、监控录像抽查等方式全程监督，确保考试公平公正。</p>
        
        <p>同学们，高等数学的魅力在于探索真理的逻辑之美，而诚信则是开启这扇大门的唯一钥匙。当你伏案疾书时，请记住：每一道认真推导的公式、每一次独立思考的突破，都是对自己最好的嘉奖。</p>
        
        <p>愿我们以笔为刃，劈开浮躁的迷雾；以诚为盾，守护学术的纯粹。祝全体同学在本次考试中展现真实水平，收获知识与品格的双重成长！</p>
        
        <p style="text-align: right; margin-top: 30px; color: #666;">华北电力大学控制与计算机工程学院<br>2025年11月27日</p>
    </div>

    <button class="read-complete-btn" id="readCompleteBtn" onclick="showSignature()">
        我已阅读完毕，进入签字
    </button>

    <!-- 签字区域 -->
    <div class="signature-section" id="signatureSection" style="display: none;">
        <h2 class="signature-title">请填写个人信息并签署您的姓名</h2>
        
        <!-- 新增个人信息输入区域 -->
        <div class="student-info">
            <div class="info-item">
                <label for="studentName">姓名：</label>
                <input type="text" id="studentName" placeholder="请输入您的姓名" required>
            </div>
            <div class="info-item">
                <label for="studentId">学号：</label>
                <input type="text" id="studentId" placeholder="请输入您的学号" required>
            </div>
            <div class="info-item">
                <label for="studentClass">班级：</label>
                <input type="text" id="studentClass" placeholder="请输入您的班级（如：计科2301）" required>
            </div>
        </div>
        
        <div class="signature-area">
            <canvas id="signatureCanvas" width="600" height="200"></canvas>
        </div>
        <div class="signature-controls">
            <button class="btn clear-btn" onclick="clearSignature()">清除签字</button>
            <button class="btn" style="background: #16a34a; color: white;" onclick="completeSignature()">完成签字</button>
        </div>
    </div>

    <!-- 确认提交区域 -->
    <div class="submit-section" id="submitSection" style="display: none;">
        <div class="confirmation-message">
            <h3>✅ 签字完成</h3>
            <p>您已成功阅读《高等数学期中考试诚信守则》并完成电子签字，请确认提交以完成承诺流程。</p>
        </div>
        <button class="btn final-submit-btn" onclick="finalSubmit()">确认提交承诺</button>
    </div>
</div>

<!-- 上传中加载提示 -->
<div class="loading-overlay" id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); justify-content: center; align-items: center; font-size: 18px; color: #333; z-index: 9999;">
    <div>提交中... 请稍候</div>
</div>

<!-- 1. 引入 LeanCloud JS SDK（必须放在最前面） -->
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.1/dist/av-min.js"></script>

<script>
    let canvas, ctx;
    let isDrawing = false;
    let hasSignature = false;

    // 2. 初始化 LeanCloud 中国版（已填入你的配置，直接使用）
    AV.init({
        appId: "v6tDMHtbS0q1Faaf1cNMELaP-gzGzoHsz",  // 你的 App ID
        appKey: "VGsQLkmnTkqUYmOsMAdgeaKA",          // 你的 App Key
        serverURL: "https://v6tDMHtb.lc-cn-n1-shared.com"  // 中国版专属 serverURL（自动匹配你的 App ID）
    });

    // 初始化画布
    function initCanvas() {
        canvas = document.getElementById('signatureCanvas');
        ctx = canvas.getContext('2d');
        
        // 响应式调整画布大小
        const containerWidth = document.querySelector('.signature-area').offsetWidth;
        canvas.width = Math.min(600, containerWidth - 40);
        canvas.height = 200;
        
        // 设置画布样式
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 鼠标事件
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // 触摸事件（移动端支持）
        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', handleTouch);
        canvas.addEventListener('touchend', stopDrawing);
    }

    // 开始绘制
    function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        hasSignature = true;
    }

    // 绘制
    function draw(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
    }

    // 停止绘制
    function stopDrawing() {
        isDrawing = false;
    }

    // 处理触摸事件
    function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                        e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }

    // 显示签字区域
    function showSignature() {
        document.getElementById('textContent').style.display = 'none';
        document.getElementById('readCompleteBtn').style.display = 'none';
        document.getElementById('signatureSection').style.display = 'block';
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step1').classList.add('completed');
        document.getElementById('step2').classList.add('active');
        
        // 初始化画布
        setTimeout(initCanvas, 100);
    }

    // 清除签字
    function clearSignature() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        hasSignature = false;
    }

    // 完成签字（新增输入框验证）
    function completeSignature() {
        // 获取输入框值
        const studentName = document.getElementById('studentName').value.trim();
        const studentId = document.getElementById('studentId').value.trim();
        const studentClass = document.getElementById('studentClass').value.trim();
        
        // 验证输入
        if (!studentName) {
            alert('请输入您的姓名！');
            return;
        }
        if (!studentId) {
            alert('请输入您的学号！');
            return;
        }
        if (!studentClass) {
            alert('请输入您的班级！');
            return;
        }
        if (!hasSignature) {
            alert('请先进行签字再继续！');
            return;
        }
        
        document.getElementById('signatureSection').style.display = 'none';
        document.getElementById('submitSection').style.display = 'block';
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step2').classList.add('completed');
        document.getElementById('step3').classList.add('active');
    }

    // 最终提交（核心：LeanCloud 存储逻辑，新增个人信息存储）
    function finalSubmit() {
        // 显示加载提示
        document.getElementById('loadingOverlay').style.display = 'flex';

        try {
            // 获取输入框值
            const studentName = document.getElementById('studentName').value.trim();
            const studentId = document.getElementById('studentId').value.trim();
            const studentClass = document.getElementById('studentClass').value.trim();
            
            // 1. 将 Canvas 签名转为 Base64 图片
            const signatureBase64 = canvas.toDataURL('image/png'); // 转为 PNG 格式的 Base64

            // 2. 上传图片到 LeanCloud 文件存储
            const blob = dataURLToBlob(signatureBase64); // Base64 转 Blob
            const signatureFile = new AV.File(`signature_${studentId}_${new Date().getTime()}.png`, blob);

            // 3. 先上传图片，再存储信息到结构化数据
            signatureFile.save().then(uploadedFile => {
                // 图片上传成功，获取图片 URL
                const signatureUrl = uploadedFile.url();

                // 4. 创建结构化数据对象（存储到 LeanCloud 的 Class 中）
                const Commitment = AV.Object.extend('HonestyCommitment'); // Class 名称：HonestyCommitment（需在 LeanCloud 提前创建）
                const commitment = new Commitment();

                // 5. 设置要存储的字段（新增姓名、学号、班级字段）
                commitment.set('studentName', studentName); // 学生姓名
                commitment.set('studentId', studentId);     // 学号
                commitment.set('studentClass', studentClass); // 班级
                commitment.set('signatureUrl', signatureUrl); // 签名图片 URL
                commitment.set('submitTime', new Date()); // 提交时间（自动生成）
                commitment.set('status', '已确认'); // 提交状态
                commitment.set('device', getDeviceType()); // 提交设备（PC/移动端）

                // 6. 保存数据到 LeanCloud
                return commitment.save();
            }).then(success => {
                // 提交成功
                document.getElementById('loadingOverlay').style.display = 'none';
                alert(`🎉 承诺提交成功！\n\n姓名：${studentName}\n学号：${studentId}\n班级：${studentClass}\n\n您已确认遵守《高等数学期中考试诚信守则》，签名信息已保存。\n预祝考试顺利，展现真实水平！`);
                // 可选：提交后跳转页面（如返回首页）
                // window.location.href = 'https://你的GitHub Pages首页';
            }).catch(error => {
                // 提交失败
                document.getElementById('loadingOverlay').style.display = 'none';
                alert(`提交失败：${error.message}\n\n请检查网络连接或 LeanCloud 配置是否正确`);
                console.error('存储失败：', error);
            });
        } catch (error) {
            document.getElementById('loadingOverlay').style.display = 'none';
            alert(`提交异常：${error.message}`);
        }
    }

    // 辅助函数：Base64 转 Blob（用于上传图片）
    function dataURLToBlob(dataURL) {
        const arr = dataURL.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], { type: mime });
    }

    // 辅助函数：获取设备类型（PC/移动端）
    function getDeviceType() {
        const userAgent = navigator.userAgent;
        if (/mobile|android|iphone|ipad|ipod/i.test(userAgent)) {
            return '移动端';
        } else {
            return 'PC端';
        }
    }

    // 页面加载完成后初始化
    window.onload = function() {
        // 初始化步骤指示器样式（补充默认样式，避免显示异常）
        document.querySelectorAll('.step').forEach(step => {
            step.style.display = 'inline-block';
            step.style.margin = '0 20px';
            step.style.textAlign = 'center';
        });
        document.querySelectorAll('.step-circle').forEach(circle => {
            circle.style.width = '30px';
            circle.style.height = '30px';
            circle.style.borderRadius = '50%';
            circle.style.backgroundColor = '#eee';
            circle.style.display = 'flex';
            circle.style.alignItems = 'center';
            circle.style.justifyContent = 'center';
            circle.style.margin = '0 auto 5px';
        });
        document.querySelector('.step.active .step-circle').style.backgroundColor = '#16a34a';
        document.querySelector('.step.active .step-circle').style.color = 'white';
        
        // 适配移动端画布大小
        window.addEventListener('resize', function() {
            if (document.getElementById('signatureSection').style.display === 'block') {
                initCanvas();
            }
        });
    };
</script>

<!-- 补充必要的样式，确保页面正常显示 -->
<style>
    .step-indicator {
        text-align: center;
        margin: 30px 0;
    }
    .step.completed .step-circle {
        background-color: #666 !important;
        color: white !important;
    }
    .text-content {
        max-width: 800px;
        margin: 0 auto;
        line-height: 1.8;
        padding: 0 20px;
    }
    .read-complete-btn {
        display: block;
        margin: 30px auto;
        padding: 12px 30px;
        background: #16a34a;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
    }
    .read-complete-btn:hover {
        background: #15803d;
    }
    .signature-section, .submit-section {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
    }
    .signature-area {
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 20px 0;
    }
    #signatureCanvas {
        width: 100%;
        border: 1px dashed #ccc;
    }
    .signature-controls {
        text-align: center;
        margin-top: 20px;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 0 10px;
        font-size: 14px;
    }
    .clear-btn {
        background: #f3f4f6;
        color: #333;
    }
    .final-submit-btn {
        background: #16a34a;
        color: white;
        padding: 12px 40px;
        font-size: 16px;
        margin-top: 20px;
    }
    .confirmation-message {
        text-align: center;
        margin-bottom: 30px;
    }
    .confirmation-message h3 {
        color: #16a34a;
        font-size: 20px;
    }
    /* 新增输入框样式 */
    .student-info {
        margin-bottom: 20px;
    }
    .info-item {
        margin: 12px 0;
        display: flex;
        align-items: center;
    }
    .info-item label {
        width: 80px;
        font-size: 16px;
        color: #333;
    }
    .info-item input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }
    .info-item input::placeholder {
        color: #999;
    }
    .info-item input:focus {
        outline: none;
        border-color: #16a34a;
        box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.1);
    }
</style>
